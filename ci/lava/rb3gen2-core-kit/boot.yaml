actions:
- deploy:
    images:
      image:
        headers:
          Authentication: Q_GITHUB_TOKEN
        url: "{{BUILD_DOWNLOAD_URL}}"
    postprocess:
      docker:
        image: ghcr.io/foundriesio/lava-lmp-sign:main
        steps:
        - export IMAGE_PATH=$PWD
        - cp overlay*.tar.gz overlay.tar.gz
        - echo "OVERLAY=overlay.tar.gz" >> $IMAGE_PATH/flash.settings
        - echo "OVERLAY_PATH=/home/" >> $IMAGE_PATH/flash.settings
        - echo "DEVICE_TYPE=qcs6490-rb3gen2" >> $IMAGE_PATH/flash.settings
        - cat $IMAGE_PATH/flash.settings
    timeout:
      minutes: 10
    to: downloads
- deploy:
    images:
      image:
        url: downloads://{{BUILD_FILE_NAME}}
      settings:
        url: downloads://flash.settings
      overlay:
        url: downloads://overlay.tar.gz
    timeout:
      minutes: 5
    to: flasher

- boot:
    method: minimal
    messages:
      - 'Linux version [0-9]'     # Helps LAVA detect kernel boot start
    auto_login:
      login_prompt: 'login:'
      username: root
      password_prompt: 'Password:'
      password: oelinux123
    prompts:
      - root@{{DEVICE_TYPE}}      # Your original prompt retained
    timeout:
      minutes: 3                 # Increased to handle first-boot delays

- test:
    timeout:
      minutes: 10
    definitions:
      # Preload AudioClips before git tests
      - from: inline
        name: preload-audioclips
        format: lava-test-shell
        run:
          steps:
            - set -e
            - AUDIO_DIR="/home/audioclips"
            - mkdir -p "${AUDIO_DIR}"
            - wget -O "${AUDIO_DIR}/AudioClips.tar.gz" "https://github.com/qualcomm-linux/qcom-linux-testkit/releases/download/Pulse-Audio-Files-v1.0/AudioClips.tar.gz"
            - tar -xzf "${AUDIO_DIR}/AudioClips.tar.gz" -C "${AUDIO_DIR}"
            - ls -la "${AUDIO_DIR}"

      - from: git
        name: "{{DEVICE_TYPE}}-smoke-test"
        path: automated/linux/smoke/smoke.yaml
        repository: https://github.com/linaro/test-definitions.git
        parameters:
          SKIP_INSTALL: "True"
          TESTS: "pwd, uname - a, ip a, dmesg"

      - from: git
        name: "{{DEVICE_TYPE}}-audio-test"
        path: Runner/plans/meta-ar-ci-premerge.yaml
        repository: https://github.com/tmoida/qcom-linux-testkit.git
        parameters:
          SKIP_INSTALL: "True"
          TESTS: "pwd, uname -a, ip a, dmesg"

- command:
    name: network_turn_on
context:
  lava_test_results_dir: /home/lava-%s
  test_character_delay: 10
device_type: {{DEVICE_TYPE}}
job_name: boot test ({{DEVICE_TYPE}}) {{GITHUB_RUN_ID}}
metadata:
  build-commit: '{{GITHUB_SHA}}'
priority: 50
timeouts:
  job:
    minutes: 20
visibility: public
