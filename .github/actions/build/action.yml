---
name: Build
description: Build the project using a Docker container

inputs:
  docker_image:
    description: Docker image to use for the build job
    required: true

  kas_file:
    description: KAS file to use for the build job   # now contains trimmed kas_basename
    required: true

  machine_name:
    description: Yocto MACHINE name to use for artifact paths
    required: true

  build_command:
    description: Command to run for the build
    required: false
    default: "bitbake qcom-multimedia-image"

  build_type:
    description: Type of build to perform (flat_build or sdk_build)
    required: false
    default: "flat_build"

runs:
  using: "composite"
  steps:

    - name: Initialize env (MACHINE, file list)
      shell: bash
      run: |
        #!/bin/bash
        set -e
        echo "MACHINE=${{ inputs.machine_name }}" >> $GITHUB_ENV
        filepath="${{ github.workspace }}/${{ inputs.machine_name }}_${{ inputs.build_type }}file_list.txt"
        echo "filepath=${filepath}" >> $GITHUB_ENV
        : > "$filepath"

    - name: Build ${{ env.MACHINE }}
      shell: bash
      run: |
        #!/bin/bash
        set -e

        filepath="${{ github.workspace }}/${{ env.MACHINE }}_${{ inputs.build_type }}file_list.txt"
        echo "filepath=${filepath}" >> $GITHUB_ENV
        touch $filepath

        USER_ID=$(id -u)
        GROUP_ID=$(id -g)
        USER=$(whoami)
        WORKSPACE=${{ github.workspace }}/..
        USER_HOME="/home/$USER"
        
        echo "::group::$(printf '__________ %-100s' 'build' | tr ' ' _)"
        docker run \
          --rm \
          --user $(id -u):$(id -g) \
          -v ${WORKSPACE}:${USER_HOME}/workspace \
          -w ${USER_HOME}/workspace \
          --privileged \
          --cpus=48 \
          --memory=96g \
          --ulimit nofile=1048576:1048576 \
          ${{ inputs.docker_image }} \
          bash -c "
            set -e
            kas shell ${{ inputs.kas_file }} -c '
              umask 022
              ${{ inputs.build_command }}
            '
          "
        echo "::endgroup::"

    - name: Create tar archive for the build
      if: ${{ inputs.build_type == 'flat_build' }}
      shell: bash
      run: |
        #!/bin/bash
        set -ex

        cd ..
        MACHINE=${{ env.MACHINE }}
        BUILD_DIR=build
        PUB_DIR=${{ github.workspace }}/pub/${MACHINE}/flat_build
        mkdir -p $PUB_DIR

        # REQUIRED CHANGE: use kas basename instead of MACHINE
        cd $BUILD_DIR/tmp/deploy/images/${{ inputs.kas_file }}
        cp qcom-multimedia-image-${{ inputs.kas_file }}.rootfs.qcomflash.tar.gz "$PUB_DIR/"

        echo "${PUB_DIR}/qcom-multimedia-image-${{ inputs.kas_file }}.rootfs.qcomflash.tar.gz" >> ${{ env.filepath }}
        ls -larth $PUB_DIR
        echo "Build artifacts created in $PUB_DIR"

    - name: copy the sdk to the pub directory
      if: ${{ inputs.build_type == 'sdk_build' }}
      shell: bash
      run: |
        #!/bin/bash
        set -ex

        cd ..
        cd build/tmp/deploy/sdk/
        sdk_file=$(ls qcom-distro-*.sh)
        PUB_DIR=${{ github.workspace }}/pub/${{ env.MACHINE }}/sdk_build
        mkdir -p $PUB_DIR
        cp $sdk_file $PUB_DIR/sdk-${MACHINE}.sh
        echo "${PUB_DIR}/sdk-${MACHINE}.sh" >> ${{ env.filepath }}
        ls -larth $PUB_DIR
        echo "SDK artifacts created in $PUB_DIR"

    - name: Upload artifacts
      uses: Audioreach/meta-audioreach/.github/actions/aws-s3-exchanger@upstream
      with:
        mode: multi-upload
        local_file: ${{ env.filepath }}
        s3_bucket: qli-prd-audior-gh-artifacts
      env:
        MACHINE: ${{ env.MACHINE }}
        BUILD_TYPE: ${{ inputs.build_type }}

    - name: Update Summary
      shell: bash
      run: |
        echo "## Build Summary for ${{ env.MACHINE }}" >> $GITHUB_STEP_SUMMARY
        echo '### :rocket: Build Successful!' >> $GITHUB_STEP_SUMMARY
        echo "- Machine: ${{ env.MACHINE }}" >> $GITHUB_STEP_SUMMARY
        echo "- Config File: ${{ inputs.kas_file }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Type: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Command: ${{ inputs.build_command }}" >> $GITHUB_STEP_SUMMARY